---
title: "A4 - An√†lisi de vari√†ncia"
author: "Salvador Sanchis Beneseit"
date: '`r format(Sys.Date(),"%B %e, %Y")`'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
```

------------------------------------------------------------------------

<br>

## 1. Introducci√≥

<br>

## 2. Lectura del fitxer i preparaci√≥ de les dades

<br>

```{r}
adult <- read.csv("~/DS21:22/advanced statistics/PAC/4/CensusIncomedata.txt", sep="")
```

<br>

### 2.1 Preparaci√≥ de les dades

<br>

Eliminem espais en blanc i convertim text a factors:

```{r}
cols <- c('workclass', 'marital_status', 'occupation', 'race', 'sex')
adult[cols] <- lapply(adult[cols], trimws)
adult[cols] <- lapply(adult[cols], factor)
```

\
<br>\
Modifiquem el nom de la columna 'sex':

```{r}
colnames(adult)[7] <- 'gender'
```

<br>

En l'histograma de la variable 'income' hi veiem una asimetria (cua a
l'esquerra):

```{r}
hist(adult$income)

```

<br>

En el gr√†fic Q-Q hi veiem una desviaci√≥ de la normalitat en la
superposici√≥ dels punts sobre la l√≠nia:

```{r}
qqnorm(adult$income)
qqline(adult$income)
```

<br>

I finalment, el valor-p del test de Lilliefors ens confirma que la
variable 'income' no es distribueix segons una distribuci√≥ normal:

```{r}
library(nortest)
lillie.test(adult$income)
```

\
<br>

Creem la nova variable 'Less50':

```{r}
adult$Less50 <- cut(adult$income, breaks=c(0,50,70), right = FALSE, labels = c(1, 0))
```

\
<br>

### 2.2 An√†lisi visual

\
<br>

Els diagrames de caixa ens indiquen que el salari √©s superior en el cas
dels homes:

```{r}
library(ggplot2)
ggplot(aes(y=income, x=gender), data=adult) + geom_boxplot()
```

<br>

Tamb√© veiem difer√®ncies pel que fa a la ra√ßa, on els salaris m√©s alts es
troben en el sector de ra√ßa blanca:

```{r}
ggplot(aes(y=income, x=race), data=adult) + geom_boxplot()
```

<br>

Pel que fa al perfil laboral, els funcionaris semblen tenir salaris m√©s
alts:

```{r}
ggplot(aes(y=income, x=workclass), data=adult) + geom_boxplot()
```

<br>

I l'estat civil que sembla acaparar salaris m√©s alts √©s casat:

```{r}
ggplot(aes(y=income, x=marital_status), data=adult) + geom_boxplot()
```

<br>

Pel que fa a la tipologia, els salaris m√©s alts es concentren en les
categories blue-collar, white-collar i professional:

```{r}
ggplot(aes(y=income, x=occupation), data=adult) + geom_boxplot()
```

\
<br>

Pel que fa a les variables cont√≠nues, veiem que la tend√®ncia √©s envers
salaris m√©s alts tal com augmenta l'edat (per aquest gr√†fic hem eliminat
els registres amb edat=99, que considerem que poden ser valors buits):

```{r}
ageplot <- adult[!(adult$age==90),]
ggplot(aes(x =age, y = income), data = ageplot) + geom_point(alpha=.1) +
  geom_smooth()
```

<br>

La variable hores de treball ens mostra els salaris m√©s alts entorn les
50 hores setmanals. Hi ha un augment addicional en la zona de les 90+
hores setmanals, per√≤ amb un marge d'error tamb√© superior, ja que es
tracta de pocs casos. (Hem eliminat 83 registres amb un valor de 99
hores setmanals treballades):

```{r}
hoursplot <- adult[!(adult$hours_per_week==99),]
ggplot(aes(x =hours_per_week, y = income), data = hoursplot) + geom_point(alpha=.1) + geom_smooth()
```

<br>

Finalment, per que fa als anys d'estudi, veiem un augment constant dels
salaris en relaci√≥ als anys d'educaci√≥:

```{r}
ggplot(aes(x =education_num, y = income), data = adult) + geom_point(alpha=.1) + geom_smooth()
```

\
<br>

## 3. Estad√≠stica inferencial

<br>

### 3.1 Contrastos d'hip√≤tesi

<br>

#### 3.1.1. Hip√≤tesi nul¬∑la i alternativa (pel g√®nere i pel cas racial)

\
<br>

Pel g√®nere:\
H~0~ : ùõç~men_income~ = ùõç~women_income~

H~1~ : ùõç~men_income~ \> ùõç~women_income~

La hip√≤tesi nul¬∑la √©s que, de mitjana, els homes cobren igual que les
dones.

La hip√≤tesi alternativa √©s que la mitjana de salari dels homes √©s
superior a la mitjana de salari de les dones.

Pel que fa al cas racial:

H~0~ : ùõç~1~ - ùõç~2¬†=~ 6.45k‚Ç¨

H~0~ : ùõç~1~ - ùõç~2¬†>~ 6.45k‚Ç¨

on ùõç~1~ denota la mitjana de salari de la gent blanca i ùõç~2~ la mitjana
de salari de la gent negra.

<br>

#### 3.1.2. Justificaci√≥ del test a aplicar (pel g√®nere i pel cas racial)

<br>

Agrupem els casos segons els factors:

```{r}

men_s <- adult$income[adult$gender=="Male"]
women_s <- adult$income[adult$gender=="Female"] 

white_s <- adult$income[adult$race=="White"]
black_s <- adult$income[adult$race=="Black"] 
```

<br>

Per les dues hip√≤tesis, assumim normalitat segons el teorema del l√≠mit
central i en ambd√≥s casos fem un contrast d'hip√≤tesi de dues mostres
sobre la mitjana.

Primer comparem vari√†ncies:

```{r}

var.test(men_s, women_s)
```

```{r}
var.test(white_s, black_s)
```

<br>

En ambd√≥s casos la vari√†ncia √©s desconeguda i diferent, i per tant farem
un test sobre mitjana de dues mostres independents amb vari√†ncia
desconeguda i diferent.

<br>

#### 3.1.3. Aplicaci√≥, interpretaci√≥ i comprovaci√≥ del test (pel g√®nere i pel cas racial)

<br>

Definim la funci√≥ per a realitzar el test:

```{r}
ind_ttest <- function(x,y,d){
x1 <-mean(x)
x2 <-mean(y)
var_1 <- var(x)
var_2 <- var(y)
n1 <- length(x)
n2 <- length(y)
sn_1 <- var_1 / n1
sn_2 <- var_2 / n2
estad√≠stic_de_contrast <- (x1-x2-d) / sqrt((var_1/n1)+(var_2/n2))
graus_de_llibertat <- ((sn_1 + sn_2)^2) / (((sn_1^2)/(n1-1))+((sn_2^2)/(n2-1)))
valor_p <- pt(estad√≠stic_de_contrast, graus_de_llibertat, lower.tail = FALSE)
valor_cr√≠tic <- qt(.95, df= graus_de_llibertat)
return(data.frame(estad√≠stic_de_contrast, graus_de_llibertat, valor_cr√≠tic, valor_p)) }
```

<br>

Apliquem el test pel cas de g√®nere:

```{r}
ind_ttest(men_s, women_s, 0)

```

<br>

El resultat del test, amb un valor observat de 194.11, per sobre del
valor cr√≠tic de 1.64, i un valor p 0, ens indica que cal rebutjar la
hip√≤tesi nul¬∑la i acceptar la hip√≤tesi alternativa segons la qual els
homes cobren m√©s que les dones.

Comprovem els resultats:

```{r}
t.test(men_s, women_s, alternative = "greater", var.equal = FALSE)
```

<br>

Apliquem el mateix test pel cas racial, amb una difer√®ncia de mitjana de
6450‚Ç¨:

```{r}
ind_ttest(white_s, black_s, 6.45)
```

\
<br>

Amb un estad√≠stic de contrast de 2.04, just per sobre del valor cr√≠tic
1.64, i un valor p de 0.02, per sota del llindar de 0.05, podem rebutjar
la hip√≤tesi nul¬∑la i concloure que les persones de ra√ßa blanca cobren
m√©s de 6450‚Ç¨ per sobre del salari de les persones de ra√ßa negra.

Comprovem els resultats:

```{r}
t.test(white_s, black_s, alternative = "greater", mu= 6.45, var.equal = FALSE)
```

\
<br>\
<br>

## 4. Model de regressi√≥ lineal

\
<br>

### 4.1. Estimaci√≥ de models

<br>

```{r}
linear_1 <- lm(income~age+education_num+hours_per_week+gender, data = adult)
summary(linear_1)
```

\
<br>

```{r}
linear_2 <- lm(income~age+education_num+hours_per_week+gender+race, data = adult)
summary(linear_2)
```

\
<br>

### 4.2. Interpretaci√≥ dels models

\
<br>

Trobem relacions significatives per a totes les variables explicatives
d'ambd√≥s models (tots els valors p\<2.2e-16), amb l'excepci√≥ del factor
"Asian-Pac_Islander" de la variable race(p=0.418).

Les variables que contribueixen en major grau al model s√≥n les variables
g√®nere i ra√ßa. Concretament, el factor 'Male' de la variable g√®nere
mostra una alta relaci√≥ positiva amb la variable dependent income. Pel
que fa a la variable ra√ßa, els factors 'black' i, especialment, 'white,
tamb√© mostren una relaci√≥ lineal positiva, i el factor 'other' mostra
una relaci√≥ negativa.

El coeficient de determinaci√≥ del primer model √©s de R^2^=0.5891, i el
del segon model √©s de R^2^=0.6674. Per tant, podem afirmar que hi ha
hagut una millora del model quan hem introdu√Øt la variable ra√ßa.

\
<br>

### 4.3. An√†lisi de residus

\
<br>

La ditribuci√≥ dels residus del model 2 √©s gaireb√© perfectament sim√®trica
entorn un valor mitj√† de 0 (min -15, max 16, 1Q -2.8, 3Q 2.7) i aix√≤
indica una bona adequaci√≥ del model.\
<br>

En un primer gr√†fic de residus contra valors ajustats veiem un patr√≥
for√ßa arbitrari, i per tant no sospitem que hi hagi un problema
d'heterocedasticitat i assumim una vari√†ncia constant en els errors del
model.

```{r}
plot(linear_2, which = 1)
```

<br>

En un gr√†fic Q-Q veiem que les dades s'justen b√© a una distribuci√≥
normal:

```{r}
plot(linear_2, which = 2)
```

\
<br>

### 4.4. Predicci√≥

\
<br>\
Aquesta √©s la predicci√≥ del model per a un seguit de dades, amb un
interval de confian√ßa del 95%:

```{r}
pre <- data.frame(age=24, education_num= 4, hours_per_week=40, gender='Female', race='Black')
predict(linear_2, pre, interval = "confidence")
```

<br>

## 5. Regressi√≥ log√≠stica

\
<br >

### 5.1. Generaci√≥ de conjunts d'entrenament i de test

\
<br>

Primer de tot, reorganitzem l'ordre dels factors de les variables
categ√≤riques, ja que aix√≤ ens ser√† necessari per dissenyar m√©s endavant
el model de regressi√≥ log√≠stica:

```{r}
adult <- within(adult, workclass <- relevel(workclass, ref = 'Private'))
adult <- within(adult, marital_status <- relevel(marital_status, ref = 'Married'))
adult <- within(adult, race <- relevel(race, ref = 'White'))
adult <- within(adult, gender <- relevel(gender, ref = 'Male'))
adult <- within(adult, Less50 <- relevel(Less50, ref = '0'))
```

<br>

Generem els conjunts d'entrenament i test:

```{r}
set.seed(1234)
div <- sample(2, nrow(adult), replace = T, prob = c(0.8, 0.2))
train <- adult[div==1,]
test <- adult[div==2,]
```

\
<br>

### 5.2. Model predictiu

<br>

Entrenem el model de regressi√≥ log√≠stica amb el conjunt 'train':

```{r}
log_1 <- glm(Less50 ~ age+workclass+education_num+marital_status+occupation+race+gender+hours_per_week, data = train, family = 'binomial')
summary(log_1)
```

\
<br>

### 5.3. Interpretaci√≥

<br>

La variable edat contribueix lleugerament de forma negativa a la
possibilitat d'un salari baix (per sota de 50k‚Ç¨). Per cada increment
d'un any d'edat es multiplica per -0.03 la probabilitat d'un salari
baix. La variable 'anys d'educaci√≥' t√© un efecte tamb√© negatiu, en un
factor de 0.28 per any d'educaci√≥. La variable 'hores setmanals' tamb√©
t√© un efecte negatiu, amb un augment amb factor -0.028 per hora
treballada.

Pel que fa al perfil de treball, ser funcionari t√© un efecte negatiu 3.5
vegades major de tenir un salari baix respecte a treballar en el sector
privat, mentre que els sectors 'aut√≤noms' i 'desconegut' tenen uns
efectes positius de 2.5 i 2.2 respectivament.

Pel que fa a l'estat civil, prenent l'estat de casat com a refer√®ncia,
els estats 'divorciat', 'separat', 'solter' i 'vidu' tenen tots efectes
positius sobre la possibilitat d'un salari baix, amb magnituds de 2.7,
3.6, 3.4 i 2.9 respectivament.

Pel que fa a la tipologia de treball, i respecte a la categoria 'Blue
Collar', les categories 'desconegut', 'professional', 'vendes' i
'serveis' tenen efectes positius sobre la possibilitat d'un salari baix,
amb magnituds de 2.9, 1.77, 2.56, 2.63, mentre que la categoria
'White-collar' disminueix la possibilitat d'un salari baix respecte a
'Blue-collar' amb una magnitud de 1.71.

Pel que fa a la ra√ßa, i respecte a la ra√ßa blanca, amerindis, asi√†tics,
negres i altres tenen relacions positives amb la possibilitat d'un
salari baix, amb magnituds de 7.86, 7.81, 6.58 i 9.49 respectivament. De
forma similar, les dones tenen un 8.47 m√©s de possibilitats de tenir un
salari baix respecte als homes.

\
<br>

### 5.4. Matriu de confusi√≥

<br>

Generem una predicci√≥ sobre el conjunt test:

```{r}
predict_Less50 <- predict(log_1, newdata = test, type = 'response')
head(predict_Less50)

```

<br>

Definim un llindar de 0.5 per les prediccions del model:

```{r}
pred_bin <- ifelse(predict_Less50>0.5, 1, 0)
test$L50pred <- as.factor(pred_bin)
```

<br>

Generem la matriu de confusi√≥:

```{r}
library(caret)

confusionMatrix(data = test$L50pred, reference = test$Less50, positive = '1')
```

A partir dels resultats de la matriu de confusi√≥, amb 292 falsos
negatius sobre un total de 3209 possibles obtenim una especificitat molt
alta (94%), i amb 198 falsos positius sobre un total possible de 3297,
el model obt√© una sensibilitat tamb√© molt alta (92%),\
<br>

### 5.5. Predicci√≥

\
<br>

Calculem manualment un primer cas:

```{r}
coefficients_calc_1 <- 0.187761+(20*-0.026909)+2.510501+(3*-0.282361)+3.474572+1.779379+(25*-0.026270)

Probability_1 = 1 / (1 + exp(-coefficients_calc_1))
Probability_1
```

Contrastem el resultat:

```{r}

income_1 <- data.frame(age=20, workclass='Self-Employed', education_num=3, marital_status='Single', occupation='Professional', race='White', gender='Male', hours_per_week=25)
predict(log_1, income_1, type = 'response')
```

\
<br>

Calculem manualment un segon cas:

```{r}
coefficients_calc_2 <- 0.187761+(60*-0.026909)-3.503788+(15*-0.282361)-1.716526+6.579412+(35*-0.026270)
Probability_2 = 1 / (1 + exp(-coefficients_calc_2))
Probability_2
```

Contrastem el resultat:

```{r}
income_2 <- data.frame(age=60, workclass='Government', education_num=15, marital_status='Married', occupation='White-Collar', race='Black', gender='Male', hours_per_week=35)
predict(log_1, income_2, type = 'response')
```

\
<br >

## 6. An√†lisi de la vari√†ncia (ANOVA) d'un factor

\
<br>

### 6.1. An√†lisi de la vari√†ncia (ANOVA) d'un factor

\
<br>

Recuperem un gr√†fic que ja hem presentat en l'apartat 2.2:

```{r}
ggplot(aes(y=income, x=race), data=adult) + geom_boxplot()
```

En el gr√†fic observem que sembla haver-hi un efecte del factor ra√ßa, amb
els individus de ra√ßa blanca que obtenen una mitjana de salaris m√©s alta
que la resta.

\
<br>\

### 6.2. Model ANOVA

<br>

#### 6.2.1. Formuleu el model

\
<br>

L'ANOVA planteja si hi ha difer√®ncies entre les mitjanes que s'obtenen
de la variable dependent en diversos nivells (factors) de la variable
independent. Encara que es prenen les mitjanes com a refer√®ncia, el que
l'ANOVA calcula √©s la difer√®ncia de vari√†ncia, ja que √©s necessari poder
detectar si dues mitjanes similars provenen de factors amb una
distribuci√≥ mot diferent l'una de l'altra. Prenent com a refer√®ncia
global la mitjana de tota la mostra, en aquest cas el que el model
planteja √©s si hi ha difer√®ncies entre les mitjanes de salari que
s'obtenen per a cada grup racial, √©s a dir, si totes s√≥n iguals, o si
n'hi ha dues que s√≥n significativament diferents entre elles.

\
<br>

#### 6.2.2. Hip√≤tesi nul¬∑la i alternativa

<br>

H~0~ : ùõç~white~ = ùõç~black~ = ùõç~black¬†¬†...¬†=~ ùõç~other~ = ùõç

H~1~ : ùõç~i~ \> ùõç~j~ per a algun i ‚â† j\

<br>

#### 6.2.3. Estimeu la significaci√≥ del factor grup racial

<br>

Obtenim la taula ANOVA:

```{r}
resultat_1 <- lm(income~race, data = adult)
table_1 <- anova(resultat_1)
table_1
```

<br>

Calculem la variabilitat explicada per la variable 'race', que resulta
ser d'un 13%:

```{r}
variabilitat <- 211909/(211909+1427206)
variabilitat
```

\
<br>

#### 6.2.4. Estimeu els efectes dels nivells del factor

<br>

Calculem els efectes de cada factor separadament, confirmant que nom√©s
el nivell 'white' contribueix positivament a l'increment del salari:

```{r}
resultat_2 <- aov(income~race, data = adult)
model.tables(resultat_2, type='effects')
```

<br>

#### 6.2.5. Realitzeu els contrastos dos-a-dos

<br>

Realitzem un test LSD, on veiem que hi ha difer√®ncies significatives
entre el grup blancs i la resta dels grups, i tamb√© del grup 'altres'
envers la resta. Els resultats ens mostren 4 subgrups, amb difer√®ncies
significatives entre cada subgrup (els subgrups s'identifiquen amb les
lletres a, b, c i d en els resultats del test):

```{r}
library(agricolae)
LSD.test(resultat_1, 'race', group=T, p.adj='bonferroni', console=T)
```

\
<br>

Realitzem un segon test que confirma els resultats, on hi podem veure
els nivells de significaci√≥ de les difer√®ncies entre grups:

```{r}
library(stats)
pairwise.t.test(adult$income, adult$race, p.adj='bonferroni')
```

\
<br>

#### 6.2.6. Adequaci√≥ del model

\
<br>

##### 6.2.6.1. Homocedasticitat dels residus

\
<br>

```{r}
plot(resultat_1, which = 1)
```

No observem un patr√≥ molt clar en el gr√†fic, i per tant no podem afirmar
que hi hagi un problema d'homocedasticitat.\
<br>

##### 6.2.6.2. Normalitat dels residus

<br>

```{r}
plot(resultat_1, which = 2)
```

S√≠ que observem, en canvi, una desviaci√≥ de la normalitat dels residus.

Seguidament, apliquem un test de Kruskal-Wallis, que no assumeix la
normalitat de la distribuci√≥ de les dades, i obtenim resultats que
confirmen la difer√®ncia significativa entre grups:

```{r}
kruskal.test(income~race, data = adult)
```

\
<br>

## 7. ANOVA multifactorial

\
<br>

### 7.1. Estudi visual de la interacci√≥

\
<br>

A la seg√ºent taula veiem que no tenim un escenari balancejat, ja que
tenim un nombre diferent de mostres per a cada condici√≥. El problema de
treballar amb un escenari no balancejat √©s que, d'una banda, es redueix
el poder estad√≠stic de la prova, i de l'altra banda, l'estad√≠stic de la
prova √©s menys sensible a possibles desviacions de l'homocedasticitat.

```{r}
table(adult$race, adult$occupation)
```

\
<br>

En el seg√ºent gr√†fic representem la interacci√≥ entre els factors ra√ßa i
ocupaci√≥. A primera vista √©s dif√≠cil detectar si hi ha interacci√≥:

```{r}
library(ggplot2)
library(interactions)
inter <- lm(income~race*occupation, data = adult)
cat_plot(inter, pred=occupation, modx=race, geom='line')
```

\
<br>

En canvi, si ordenem els nivells de forma diferent, detectem un possible
efecte d'interacci√≥. Veiem, per exemple, que per les ocupacions
'Blue-Collar' i 'Sales', la dist√†ncia entre la ra√ßa blanca i la resta √©s
m√©s gran. En general, mentre la l√≠nia de la ra√ßa blanca dibuixa un
descens gradual a trav√©s dels diferents nivells del factor ocupaci√≥, les
altres races dibuixen altibaixos:

```{r}
adult$occupation <- factor(adult$occupation, levels = c('Blue-Collar', 'White-Collar', 'Professional', 'Sales', 'Service', 'Other/Unknown'))

library(ggplot2)
library(interactions)
inter <- lm(income~race*occupation, data = adult)
cat_plot(inter, pred=occupation, modx=race, geom='line')
```

\
<br>

## 8. Conclusions

<br>

Hem analitzat un conjunt de dades provinents d'un cens sobre els salaris
i informaci√≥ personal, amb un total de 32,560 registres i 9 variables.

Despr√©s de preparar les dades per a l'an√†lisi, hem realitzat una an√†lisi
visual, amb la qual hem inicialment observat que entre els grups
diferents que hi ha al conjunt, els salaris m√©s alts els concentren els
homes, les persones de ra√ßa blanca, els funcionaris de l'estat, les
persones casades, els obrers (lleugerament per sobre d'administradors i
treballadors del sector professional), les persones de m√©s edat enfront
de les joves, les persones que treballen m√©s hores per setmana, i les
persones amb m√©s anys d'estudis.

Fent contrastos d'hip√≤tesis hem pogut comprovar que els homes cobren
significativament m√©s que les dones, i que les persones de ra√ßa blanca
tenen un salari anual 6450‚Ç¨ per sobre del salari mitj√† de les persones
de ra√ßa negra.

Amb un model de regressi√≥ lineal hem pogut comprovar que les variables
'edat', 'anys d'educaci√≥', 'hores setmanals treballades', 'g√®nere' i
'ra√ßa' contribueixen conjuntament a explicar un 67% de la vari√†ncia de
la variable 'salari anual'.

Amb un model de regressi√≥ log√≠stica, on hem analitzat la possibilitat
que un individu cobri menys de 50,000‚Ç¨ anuals, hem observat que els
factors que contribueixen a aquesta possibilitat s√≥n tenir menys edat,
treballar menys hores, ser aut√≤nom, ser separat o solter, treballar en
els sectors de vendes o serveis, ser dona, i ser de qualsevol altra ra√ßa
que blanca.

Amb una an√†lisi de la vari√†ncia hem comprovat que les difer√®ncies entre
mitjanes de salari entre grups racials s√≥n significatives. Tant la ra√ßa
blanca com la ra√ßa negra tenen mitjanes de salari significativament
diferents entre elles aix√≠ com amb la resta de races. Com que els
residus del model de regressi√≥ log√≠stica no es distribueixen amb
normalitat, hem realitzat un test de Kruskal-Wallis per confirmar que
aquestes difer√®ncies s√≥n estad√≠sticament significatives.

Finalment, hem fet un estudi preliminar a un model d'an√†lisi de
vari√†ncia multifactorial prenent les races i les ocupacions com a
factors explicatius del salari. Hem trobat que no tenim un escenari
balancejat per tal d'estimar aquest model de forma √≤ptima, i tamb√© hem
observat un lleuger efecte d'interacci√≥ entre les variables explicatives
ra√ßa i ocupaci√≥.

<br>\
\
<br>\
\
<br>\
\
<br>
